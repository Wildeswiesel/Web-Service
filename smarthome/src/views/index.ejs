<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>SmartHome - √úbersicht</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <%- include('partials/header') %>
  
  <h1>SmartHome-Dashboard</h1>
  
  <section>
    <h2>Vorhandene R√§ume</h2>
    <table>
      <thead>
        <tr>
          <th>Raum ID</th>
          <th>Raumtemperatur</th>
          <th>Reduzierte Temperatur</th>
          <th>Aktuelle Temperatur</th>
        </tr>
      </thead>
      <tbody>
        <% rooms.forEach(room => { %>
          <tr data-room-id="<%= room.roomid %>">
            <td><%= room.roomid %></td>
            <td><%= room.room_temperature %>¬∞C</td>
            <td><%= room.reduced_temperature %>¬∞C</td>
            <td><%= room.current_temperature %>¬∞C</td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>
  <section>
    <h2>Vorhandene Ger√§te</h2>
    <table>
      <thead>
        <tr>
          <th>Device ID</th>
          <th>Typ</th>
          <th>Raum</th>
          <th>Aktion</th>
          <th>L√∂schen</th>
        </tr>
      </thead>
      <tbody>
        <% devices.forEach(device => { %>
          <tr data-device-id="<%= device.deviceid %>" class="<%= device.type === 'thermostat' ? 'thermostat-row' : '' %>">
            <td><%= device.deviceid %></td>
            <td><%= device.type %></td>
            <td><%= device.roomid || '‚Äî' %></td>
            <td>
              <% if (device.type === 'thermostat') { %>
                  <!-- Anzeige: heatingMode wird per Polling aktualisiert -->
                  <span class="heating-mode">Stufe: ‚Äì</span><!--  -- ver√§ndert zu der Stufe des Thermostats (0,1,2,3,4,5) -->
              <% } else if (device.type === 'fensterkontakt') { %>
                <button onclick="moveWindow('<%= device.deviceid %>', 'up')">‚ñ≤</button>
                <button onclick="moveWindow('<%= device.deviceid %>', 'down')">‚ñº</button>
              <% } else { %>
                ‚Äì
              <% } %>
            </td>
            <td>
              <!-- L√∂sch-Button hinzuf√ºgen -->
              <button onclick="deleteDevice('<%= device.id %>')">üóëÔ∏è L√∂schen</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <section>
    <h2>Neues Ger√§t registrieren</h2>
    <form action="/register" method="POST">
      <div>
        <label for="type">Ger√§tetyp:</label>
        <select name="type" id="type">
          <option value="fensterkontakt">Fensterkontakt</option>
          <option value="thermostat">Thermostat</option>
        </select>
      </div>
      <div>
        <label for="roomId">Raum:</label>
        <input type="text" name="roomId" id="roomId" placeholder="z.B. Wohnzimmer" />
      </div>
      <button type="submit">Registrieren</button>
    </form>
  </section>

  <script>
      function moveWindow(deviceId, direction) {
        console.log(`Ger√§t ${deviceId} bewegt sich ${direction}`);
        // muss noch erweitert werden
      }

      async function deleteDevice(deviceId) {
        if (!confirm("Willst du dieses Ger√§t wirklich l√∂schen?")) return;
        try {
          const response = await fetch(`/devices/${deviceId}`, { method: 'DELETE' });
          if (response.ok) {
            alert("Ger√§t erfolgreich gel√∂scht!");
            location.reload(); // Seite neu laden, um das entfernte Ger√§t nicht mehr anzuzeigen
          } else {
            const errorText = await response.text();
            alert("Fehler beim L√∂schen: " + errorText);
          }
        } catch (error) {
          console.error("Fehler beim L√∂schen des Ger√§ts:", error);
          alert("Es gab ein Problem beim L√∂schen des Ger√§ts.");
        }
      }

      // Diese Funktion holt den Status jedes Thermostats und aktualisiert den angezeigten heatingMode
      async function updateThermostatStatuses() {
        const rows = document.querySelectorAll('tr.thermostat-row');
        for (const row of rows) {
          const deviceId = row.getAttribute('data-device-id');
          try {
            const res = await fetch(`/thermostats/${deviceId}/status`);
            if (res.ok) {
              const data = await res.json();
              if (row.querySelector('.heating-mode')) {
                row.querySelector('.heating-mode').textContent = 'Stufe: ' + data.heatingMode;
              }
            }
          } catch (err) {
            console.error(`Fehler beim Aktualisieren des Status f√ºr Ger√§t ${deviceId}:`, err);
          }
        }
      }

      // Jede Sekunde wird der Status aktualisiert
      updateThermostatStatuses();
      setInterval(updateThermostatStatuses, 3000);
  </script>
</body>
</html>

